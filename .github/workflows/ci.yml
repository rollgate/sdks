name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'
  NODE_OPTIONS: '--dns-result-order=ipv4first'

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

  sdk-core:
    name: SDK Core Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-core -- --coverage

  sdk-node:
    name: SDK Node.js Tests
    runs-on: ubuntu-latest
    needs: sdk-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Build SDK Node
        run: npm run build --workspace=@rollgate/sdk-node

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-node -- --coverage

  sdk-react:
    name: SDK React Tests
    runs-on: ubuntu-latest
    needs: sdk-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Build SDK Browser
        run: npm run build --workspace=@rollgate/sdk-browser

      - name: Build SDK React
        run: npm run build --workspace=@rollgate/sdk-react

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-react -- --coverage

  sdk-vue:
    name: SDK Vue Tests
    runs-on: ubuntu-latest
    needs: sdk-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Build SDK Browser
        run: npm run build --workspace=@rollgate/sdk-browser

      - name: Build SDK Vue
        run: npm run build --workspace=@rollgate/sdk-vue

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-vue -- --coverage --passWithNoTests

  sdk-angular:
    name: SDK Angular Tests
    runs-on: ubuntu-latest
    needs: sdk-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Build SDK Browser
        run: npm run build --workspace=@rollgate/sdk-browser

      - name: Build SDK Angular
        run: npm run build --workspace=@rollgate/sdk-angular

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-angular -- --coverage --passWithNoTests

  sdk-svelte:
    name: SDK Svelte Tests
    runs-on: ubuntu-latest
    needs: sdk-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build SDK Core
        run: npm run build --workspace=@rollgate/sdk-core

      - name: Build SDK Browser
        run: npm run build --workspace=@rollgate/sdk-browser

      - name: Build SDK Svelte
        run: npm run build --workspace=@rollgate/sdk-svelte

      - name: Run tests
        run: npm run test --workspace=@rollgate/sdk-svelte -- --coverage --passWithNoTests

  sdk-go:
    name: SDK Go Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/sdk-go
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Download dependencies
        run: go mod download

      - name: Build
        run: go build -v ./...

      - name: Run tests
        run: go test -v -coverprofile=coverage.out ./...

  sdk-java:
    name: SDK Java Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/sdk-java
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.6

      - name: Build and test
        run: mvn -B clean test

  sdk-python:
    name: SDK Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/sdk-python
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest --cov=rollgate --cov-report=xml

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, sdk-core, sdk-node, sdk-react, sdk-vue, sdk-angular, sdk-svelte, sdk-go, sdk-java, sdk-python]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## SDK Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Core | ${{ needs.sdk-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | ${{ needs.sdk-node.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| React | ${{ needs.sdk-react.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vue | ${{ needs.sdk-vue.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Angular | ${{ needs.sdk-angular.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Svelte | ${{ needs.sdk-svelte.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go | ${{ needs.sdk-go.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java | ${{ needs.sdk-java.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ needs.sdk-python.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any test failed
        if: |
          needs.lint.result == 'failure' ||
          needs.sdk-core.result == 'failure' ||
          needs.sdk-node.result == 'failure' ||
          needs.sdk-react.result == 'failure' ||
          needs.sdk-vue.result == 'failure' ||
          needs.sdk-angular.result == 'failure' ||
          needs.sdk-svelte.result == 'failure' ||
          needs.sdk-go.result == 'failure' ||
          needs.sdk-java.result == 'failure' ||
          needs.sdk-python.result == 'failure'
        run: exit 1
